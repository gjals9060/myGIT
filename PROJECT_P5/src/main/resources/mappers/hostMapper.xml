<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.clover.p5.host.mapper.HostMapper">
	
	
	<!-- 호스트 등록 -->
	<insert id="insertHost" parameterType="NewHostDTO">
		INSERT INTO host
		VALUES
		(
			SEQ_host_id.nextval,
			#{memberId},
			#{name},
			#{description},
			#{descriptionEtc},
			#{type},
			#{roomType},
			#{capacity},
			#{roomCount},
			#{bedCount},
			#{bathroomCount},
			#{address},
			#{latitude},
			#{longitude},
			#{isTv},
			#{isWifi},
			#{isAirConditioner},
			#{isAirPurifier},
			#{isHairDryer},
			#{isIron},
			#{isKitchen},
			#{isWashingMachine},
			#{isElevator},
			#{isParkingLot},
			#{minimumStay},
			#{maximumStay},
			#{price},
			TO_DATE(#{creationDate}, 'YYYY-MM-DD HH24:MI:SS'),
			NULL
								)
	</insert>
	
	
	<select id="selectNewHostId" parameterType="int" resultType="int">
		SELECT MAX(id)
		FROM host
		WHERE member_id = #{memberId}
	</select>
	
	
	<!-- foreach문에서는 trigger로! .nextval이 안먹힌다 -->
	<!-- 예약 차단일 등록 -->
	<insert id="insertBlocking">
		<foreach collection="arrBlockingDate" item="blockingDate"
		 separator=" " open="INSERT ALL " close="SELECT * FROM DUAL">
			INTO blocking
			(	
				host_id,
				blocking_date
								)
			VALUES
			(	
				#{hostId},
				TO_DATE(#{blockingDate}, 'MM/DD/YYYY')
														)
		</foreach>
	</insert>
	
	<!-- 호스트 사진 저장 -->
	<insert id="insertHostPhoto">
		<foreach collection="list" item="photo"
		 separator=" " open="INSERT ALL " close="SELECT * FROM DUAL">
			INTO host_photo
			(
				host_id,
				original_name,
				file_size,
				path,
				sort_order
								)
			VALUES
			(	
				#{photo.hostId},
				#{photo.originalName},
				#{photo.fileSize},
				#{photo.path},
				#{photo.sortOrder}
									)
		</foreach>
	</insert>
	
	<!-- 호스트(숙소) 사진이 있나 확인 -->
	<select id="selectHostPhotoCount" resultType="int">
		SELECT count(*)
		FROM host_photo
		WHERE host_id = #{hostId}
	</select>
	<!-- 사진이 있다면 사진의 index 최댓값 구함 -->
	<select id="selectHostPhotoSortOrderMax" resultType="int">
		SELECT max(sort_order)
		FROM host_photo
		WHERE host_id = #{hostId}
	</select>
	
	<!-- 호스트에 등록된 사진 목록을 검색 -->
	<select id="selectHostPhotoList" resultType="HostPhoto">
		SELECT *
		FROM host_photo
		WHERE host_id = #{hostId}
		ORDER BY sort_order
	</select>
	
	<!-- 호스트에 등록된 사진을 삭제 -->
	<delete id="deleteHostPhoto"> <!-- 파라미터 타입은 안써줘도 되는가 -->
		DELETE
		FROM host_photo
		WHERE id = #{hostPhotoId}
	</delete>
	
	<!-- 호스트 사진 정렬 순서 저장 -->
	<update id="updateHostPhotoSort">
		<foreach collection="array" item="photoId" index="index" 
      		separator=";" open="DECLARE BEGIN" close="; END;" >
		 UPDATE host_photo
		 SET sort_order = #{index} + 1
		 WHERE id = #{photoId}
	  	</foreach>
	</update>
	
	<!-- 대표 이미지 변경에 사용 -->
	<update id="updateHostPhoto">
		UPDATE host_photo
		SET sort_order = #{sortOrder}
		WHERE id = #{photoId}
	</update>




</mapper>