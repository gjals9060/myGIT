<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.clover.p5.host.mapper.HostMapper">

	<select id="selectHost" parameterType="String" resultType="HostInfoDTO">
		<![CDATA[
			SELECT
				h.*, m.first_name,  m.last_name
			FROM
				host h, member m
			WHERE
				h.id = #{id}
			AND
				(m.id = h.member_id)	
		]]>	
	
	</select>
	
	<select id="selectHostList" parameterType="SearchHostDTO" resultType="HostInfoDTO">
		<!--
		CDATA 사용 이유!
		https://epthffh.tistory.com/entry/Mybatis-%EC%97%90%EC%84%9C-CDATA-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0
		-->
		
		<![CDATA[
			SELECT 
				DISTINCT h.*, m.first_name, m.last_name
			FROM 
				host h FULL OUTER JOIN blocking b ON(h.id = b.host_id), member m
			WHERE 
				(NOT b.blocking_date BETWEEN TO_DATE(#{sStartDate},'MM/DD/YYYY') 
			AND
				TO_DATE(#{sEndDate},'MM/DD/YYYY')
			OR
				b.blocking_date IS NULL)
			AND
				(h.latitude BETWEEN #{swLatitude} AND #{neLatitude})
			AND
				(h.longitude BETWEEN #{swLongitude} AND #{neLongitude})
			AND
				h.capacity >= #{capacity}
			AND
				(m.id = h.member_id)
			ORDER BY
				h.id

		]]>
	
	</select>
	
	
	<!-- 호스트 등록 -->
	<insert id="insertHost" parameterType="NewHostDTO">
		INSERT INTO host
		VALUES
		(
			SEQ_host_id.nextval,
			#{memberId},
			#{name},
			#{description},
			#{descriptionEtc},
			#{type},
			#{roomType},
			#{capacity},
			#{roomCount},
			#{bedCount},
			#{bathroomCount},
			#{address},
			#{latitude},
			#{longitude},
			#{isTv},
			#{isWifi},
			#{isAirConditioner},
			#{isAirPurifier},
			#{isHairDryer},
			#{isIron},
			#{isKitchen},
			#{isWashingMachine},
			#{isElevator},
			#{isParkingLot},
			#{minimumStay},
			#{maximumStay},
			#{price},
			TO_DATE(#{creationDate}, 'YYYY-MM-DD HH24:MI:SS'),
			NULL
								)
	</insert>
	
	
	<select id="selectNewHostId" parameterType="int" resultType="int">
		SELECT MAX(id)
		FROM host
		WHERE member_id = #{memberId}
	</select>
	
	
	<!-- foreach문에서는 trigger로! .nextval이 안먹힌다 -->
	<!-- 예약 차단일 등록 -->
	<insert id="insertBlocking">
		<foreach collection="arrBlockingDate" item="blockingDate"
		 separator=" " open="INSERT ALL " close="SELECT * FROM DUAL">
			INTO blocking
			(	
				host_id,
				blocking_date
								)
			VALUES
			(	
				#{hostId},
				TO_DATE(#{blockingDate}, 'MM/DD/YYYY')
														)
		</foreach>
	</insert>
	
	
	<!-- 호스트 사진 저장 -->
	<insert id="insertHostPhoto">
			INSERT INTO host_photo
			VALUES
			(
				SEQ_host_photo_id.nextval,
				#{hostId},
				#{originalName},
				#{fileSize},
				#{path}
									)
	</insert>
	
	





</mapper>