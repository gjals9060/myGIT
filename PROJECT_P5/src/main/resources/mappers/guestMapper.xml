<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.clover.p5.guest.mapper.GuestMapper">
	
	<!-- postPage에 뿌려줄 host관련 정보(사진은 따로) -->
	<select id="selectHost" parameterType="String" resultType="HostInfoDTO">
		<![CDATA[
			SELECT
				h.*, m.first_name,  m.last_name
			FROM
				host h, member m
			WHERE
				h.id = #{id}
			AND
				(m.id = h.member_id)	
		]]>	
	
	</select>
	
	<!-- 호스트 사진 출력 -->
	<select id="selectHostPhoto" parameterType="String" resultType="HostPhotoDTO">
		
		SELECT
			*
		FROM
			host_photo
		WHERE
			host_id = #{hostId}
		ORDER BY
			sort_order ASC
			
		
	</select>
	
	<select id="selectBlocking" parameterType="String" resultType="Date">
	
		SELECT
			blocking_date
		FROM
			blocking
		WHERE
			host_id = #{hostId}
		ORDER BY
			id
	
	</select>
	
	<select id="selectHostList" parameterType="SearchHostDTO" resultType="HostInfoDTO">
		<!--
		CDATA 사용 이유!
		https://epthffh.tistory.com/entry/Mybatis-%EC%97%90%EC%84%9C-CDATA-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0
		-->
			SELECT 
			    h.*, m.first_name, m.last_name
			FROM 
			    host h
			        LEFT JOIN member m
			        ON h.member_id = m.id
			WHERE
			    h.name IS NOT NULL
			AND 
			    m.id IS NOT NULL
			AND
				(h.latitude BETWEEN #{swLatitude} AND #{neLatitude})
			AND
				(h.longitude BETWEEN #{swLongitude} AND #{neLongitude})
			<if test="guestCount != 0">
			AND
				h.capacity <![CDATA[>=]]> #{guestCount}
			</if>
			AND 
			    h.id NOT IN(        
			        SELECT 
			            DISTINCT h.id
			        FROM 
			            host h
			                INNER JOIN 
			                blocking b 
			                ON h.id = b.host_id
			        WHERE 
			            (b.blocking_date BETWEEN TO_DATE(#{sStartDate},'YYYY.MM.DD') 
			                AND
			                    TO_DATE(#{sEndDate},'YYYY.MM.DD'))
				)
			ORDER BY
				h.id	
				

		
	
	</select>
	
	<insert id="insertBooking" parameterType="ReservationInfoDTO">
		
		INSERT 
		INTO
			booking
		VALUES(
			SEQ_booking_id.nextval,
			#{hostId},
			#{memberId},
			TO_DATE(#{checkInDate},'YYYY.MM.DD'),
			TO_DATE(#{checkOutDate},'YYYY.MM.DD'),
			#{guestCount},
			#{payment},
			TO_DATE(#{bookingDate},'YYYY.MM.DD HH24:MI:SS'),
			NULL,
			NULL		
		)
	
	</insert>

</mapper>
	